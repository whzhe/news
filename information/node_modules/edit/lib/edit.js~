//var mysql   = require('mysql');
//var db = require('db');
var mongodb = require('mongodb');
var server = new mongodb.Server('localhost', 27107, {auto_reconnect:true});
var db = new mongodb.Db('mydb', server, {safe:true});


db.open(function(err,db){
    if(!err){
        console.log('connect db');
        db.creatCollection('mycoll',{safe:true}, function(err,collection){
            if(err){
                console.log(err);
            }else
            {
                console.log('creat collection ok');
            }
        });
    }
});



function send_result(res, type, retCode, errStr){
    var ret = {
        Type:type, 
        ret: retCode,
        errStr: errStr,
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}
function send_result_data(res, type, retCode, data) {
    var ret = {
        Type:type, 
        ret: retCode,
        data: data,
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}
function message_handle(req, res){      
    var message = req.body;
    //var msgType = message.type;
    var msgType = message.msgType;
    console.log(req.body);
    if("MSM_TYPE_EDIT_GET_NEWS_1" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var startIdx = message.startIdx;
        var count = 30;
        var category = message.category;
        var out = collection.find({State:0}).toArray(function(err,docs){
            if(err){
                send_result(res, type, 1, err);
                console.log('find');
                console.log(docs);
                return;
            }
            else{
                console.log(docs);
            }
        });
        var i = startIdx;
        var result;
        while (i < (startIdx+count)){
            var j =0;
            result[j] = out[i];
            j++;
            i++;
        }
        send_result_data(res, type, 0 ,result);
        return;
    }
    if("MSM_TYPE_EDIT_GET_NEWS_2" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var startIdx = message.startIdx;
        var count = 30;
        var category = message.category;
        var out = collection.find({States:1}).toArray(function(err,docs){
            if(err){
                send_result(res, type, 1, err);
                console.log('find');
                console.log(docs);
                return;
            }
            else{
                console.log(docs);
            }
        });
        var i = startIdx;
        var result;
        while (i < (startIdx+count)){
            var j =0;
            result[j] = out[i];
            j++;
            i++;
        }
        send_result_data(res, type, 0 ,result);
        return;
    }
    if("MSM_TYPE_EDIT_EDIT_NEWS_1" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var id = message.id;
        var title = message.title;
        var content = message.content;
        var editorScore = message.editorScore;
        var tmp = {Title:title, EditorScore:editorScore, Content:Content, States:1};
        collection.update({_id:id},{$set:tmp},{safe:true},function(err, result){
            if(err){
                send_result(res, type, 1, err);
                console.log(err);
                return;
            }
            else{
                console.log(result);
            }
        });
        send_result(res, type, 0);
        return;
    }

     if("MSM_TYPE_EDIT_EDIT_NEWS_2" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var id = message.id;
        var title = message.title;
        var content = message.content;
        var editorScore = message.editorScore;
        var tmp = {Title:title, EditorScore:editorScore, Content:Content};
        collection.update({_id:id},{$set:tmp},{safe:true},function(err, result){
            if(err){
                send_result(res, type, 1, err);
                console.log(err);
                return;
            }
            else{
                console.log(result);
            }
        });
        send_result(res, type, 0);
        return;

    }   }
    if("MSM_TYPE_EDIT_PUBLISH_NEWS" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var id = message.id;
        var i =0;
        while (id[i] != null){

            var tmp = {States:2};
            collection.update({_id:id[i]},{$set:tmp},{safe:true},function(err, result){
                if(err){
                    send_result(res, type, 1, err);
                    console.log(err);
                    return;
                }
                else{
                    console.log(result);
                }
            });
            i++;
        }
        send_result(res, type, 0,"Success!");
        return;

    }
    if("MSM_TYPE_EDIT_RECALL_NEWS" == msgType){

        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var id = message.id;
        var i =0;
        while (id[i] != null){

            var tmp = {States:1};
            collection.update({_id:id[i]},{$set:tmp},{safe:true},function(err, result){
                if(err){
                    send_result(res, type, 1, err);
                    console.log(err);
                    return;
                }
                else{
                    console.log(result);
                }
            });
            i++;
        }
        send_result(res, type, 0,"Success!");
        return;

    }
 
    if("MSM_TYPE_EDIT_DEL_NEWS" == msgType){
        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1, err);
                return;
            }
        });
        var id = message.id;
        var i =0;
        while(id[i] == null){

            collection.remove({_id:id[i]},{safe:true},function(err, result){
                if(err){
                    send_result(res, type, 1, err);
                    console.log(err);
                    return;
                }
                else{
                    console.log(result);
                }
            });
            i++;
        }
        send_result(res, type, 0,"Success!");
        return;

    }
    else{
        send_result(res, "null", 1, "no msgType!");
        return;
    }

}
