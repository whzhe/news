//var mysql   = require('mysql');
//var db = require('db');
var mongodb = require('mongodb');
var server = new mongodb.Server('localhost', 27107, {auto_reconnect:true});
var db = new mongodb.Db('mydb', server, {safe:true});


db.open(function(err,db){
    if(!err){
        console.log('connect db');
        db.creatCollection('mycoll',{safe:true}, function(err,collection){
            if(err){
                console.log(err);
            }
            else
            {
                console.log('creat collection ok');
            }
        });
    }
});




function send_result(res, type, retCode, errStr){
    var ret = {
        Type:type, 
        ret: retCode,
        errStr: errStr,
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}
function send_result_data(res, type, retCode, data) {
    var ret = {
        Type:type, 
        ret: retCode,
        data: data,
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}
function message_handle(req, res){      
    var message = req.body;
    //var msgType = message.type;
    var msgType = message.msgType;
    console.log(req.body);
    if("MSM_TYPE_NEWS_GET_NEW" == msgType){
        type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
                send_result(res, type, 1,err);
                return;
            }
        });
        var startIdx = message.startIdx;
        var count = 30;
        var category = message.category;
        var out = collection.find({States:2}).toArray(function(err,docs){
           if(err){
               send_result(res, type, 1, err);
               console.log('find');
               console.log(docs);
               return;
           }
           else{
               console.log(docs) 
           }
        });
        var i = startIdx;
        var result;
        while (i < (startIdx+count)){
            var j =0;
            result[j] = out[i];
            j++;
            i++;
        }
        send_result_data(res, type, 0 ,result);
        return;
    }
    else{
        send_result(res, "null", 1, "no msgType!");
        return;
    }
};
