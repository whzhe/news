//var mysql   = require('mysql');
//var db = require('db');
var mongodb = require('mongodb');
var server = new mongodb.Server('localhost', 27107, {auto_reconnect:true});
var db = new mongodb.Db('mydb', server, {safe:true});


db.open(function(err,db){
    if(!err){
        console.log('connect db');
        db.creatCollection('mycoll',{safe:true}, function(err,collection)){
            if(err){
                console.log(err);
            }else
            {
                console.log('creat collection ok');
            }
        }
    }
});



function send_result(res, type, retCode, errStr, commandId) {
    var ret = {
        Type:type, 
        ret: retCode,
        errStr: errStr,
        commandId: commandId
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}

function message_handle(req, res){      
    var message = req.body;
    //var msgType = message.type;
    var msgType = message.msgType;
    console.log(req.body);

    if("News_add" == msgType){
    
        var title = message.title;
        var time = message.time;
        var sum = message.sum;
        var state = message.state;
        var label = message.label;
        var source = message.source;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
            }
        });
        var tmp = {Title:title, Time:time, Sum:sum, Label:label, Source:Source, State: state};
        collection.insert(tmp,{safe:true},function(err, result){

            console.log(result);
        });
    }
    if("MSG_TYPE_INTERNEL_NEW_NEWS" == msgType){
        var category = message.category;
        var title = message.title;
        var content = message.content;
        var source = message.source;
        var oriUrl = message.oriUrl;
        var newsTime = message.newsTime;
        var audioFile = message.audioFile;
        var voiceType = message.voiceType;
        var audoFileSuffix = message.audoFileSuffix;
        var imageFile = message.imageFile;
        var type = msgType;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(result);
            }
        });
        var tmp = {Title:title, NewsTime:newsTime, Content:content, Category:Category, Source:Source, OriUrl:OriUrl, AudioFile:AudioFile,VoiceType:VoiceType, AudoFileSuffix:AudoFileSuffix, ImageFile;ImageFile};
        collection.insert(tmp,{safe:true},function(err, result){
            console.log(result);
        });
        send_result(res, type, 0, "Success!");
    }
    }
    if("MSM_TYPE_NEWS_GET_NEW" == msgType){

        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
            }
        });
        var startIdx = message.startIdx;
        var count = 30;
        var category = message.category;
        var out = collection.find()toArray(function(err,docs){
            console.log('find');
            console.log(docs);
        });
        var i = startIdx;
        var result;
        while (i < (startIdx+count)){
            var j =0;
            result[j] = out[i];
            j++;
            i++;
        }
        send_result(res, type, 0 , data)
        var user = db.collection('User');
        var grade = user.find({userID:userid},{_id:0,Grade:1});
        if (grade == 1){
            
        
            var out = collection.find()toArray(function(err,docs){
                console.log('find');
                console.log(docs);
            });
            var i = offset;
            var result;
            while(i <(offset+count)){
                var j = 0;
                result[j] =out[i];
                j++;
                i++;
            }
            res.send(result);
        }
        else if (grade == 0){
            var out = collection.find({State:state})toArray(function(err,docs){
                console.log('find');
                console.log(docs);
            });
            var i = offset;
            var result;
            while(i <(offset+count)){
                var j = 0;
                result[j] = out [i];
                j++;
                i++;
            }
            res.send(result);

        }

    }
    if("News_update" == msgType){
        var id = message.id;
        var title = message.title;
        var time = message.time;
        var state = message.state;
        var sum = message.sum;
        var label = message.label;
        var source = message.source;
        db.collection('mycoll',{safe:true}, function(err, collection){
            if(err){
                console.log(err);
            }
        });
        var tmp = {Title:title, Time:time, Sum:sum, Label:label, Source:source, State:state};
        collection.update(tmp,{$set:{_id:id}},{safe:true},function(err, result){
     
            console.log(result);
        });
    }
    if("News_pub" == msgType){
        var id = message.id;
        var title = message.title;
        var time = message.time;
        var sum = message.sum;
        var label = message.label;
        var source = message.source;
        var state = message.state;
        db.collection('mtcoll',{safe:true}, function(err, collection)){
            if(err){
                console.log(err);
            }
        });
        var tmp = {Title:title, Time:time, Sum:sum, Label:label, Source:source,State:state};
        collection.update(tmp,{$set:{_id:id}},{safe:true},function(err,result){
            console.log(result);
        });
    }




}
